/*! barbell 2014-06-13 */
function PlateConfiguration(a,b){this.size=a,this.count=b}function Set(a,b){this.displayWeight=a,this.plateConfiguration=b}function SetScheme(a){for(var b=["units","barbellWeight","weightToCalculate","plates","ignoreSmallPlates","warmupScheme"],c=["optimize","multiWeightMode"],d=0;d<b.length;d++){if("undefined"==typeof a[b[d]])throw new Error("required key "+b[d]+" is missing");this[b[d]]=a[b[d]]}for(d=0;d<c.length;d++)this[c[d]]="undefined"!=typeof a[c[d]]?a[c[d]]:!1;this.warmupScheme.push({percent:100,reps:0}),this.maxPlates=0,this.calculateSets=function(){var a=[];if(this.multiWeightMode){var b=this.weightToCalculate.split(/[\s*,+#;]+/);for(this.warmupScheme=[],d=0,j=b.length;j>d;d++)!isNaN(b[d])&&b[d]>0&&(this.warmupScheme.push({percent:100,reps:0}),a.push(b[d]))}var c=[],e=new PlateOptimizer;for(d=0;d<this.warmupScheme.length;d++){var f=this.multiWeightMode?a[d]:parseInt(this.weightToCalculate*this.warmupScheme[d].percent/100),g=new SetFactory(f,this.barbellWeight,this.plates.slice(0),this.ignoreSmallPlates&&100!=this.warmupScheme[d].percent,{percent:this.warmupScheme[d].percent,reps:this.warmupScheme[d].reps,units:this.units});this.optimize&&(g=e.optimize(g)),c.push(g),this.maxPlates=g.plateConfiguration.length>this.maxPlates?g.plateConfiguration.length:this.maxPlates}return c}}function SetFactory(a,b,c,d,e){var f=c.slice();f.sort(function(a,b){return a.size-b.size}),d&&(f=this.removeSmallPlates(f.slice(0),e.units));var g=f.slice(0),h=this.calculateSet(a,b,f);if(h.barbellWeight=b,h.platesToUse=g,h.ignoreSmallPlates=d,"object"==typeof e)for(var i in e)h[i]=e[i];return h}function PlateOptimizer(){this.optimize=function(a){if(!(a instanceof Set))throw new Error("PlateOptimizer.optimize accepts only Set() objects");if(100==a.percent)return a;var b=a,c=(a.platesToUse.slice(),new SetFactory(a.displayWeight,a.barbellWeight,a.platesToUse,!1,{percent:a.percent,reps:a.reps,units:a.units})),d=.9,e=1+(100-a.percent)/2.5/100,f="LB"==a.units?15:8,g="LB"==a.units?20:10,h=c.displayWeight-b.displayWeight,i="LB"==a.units?5:2,j=i*Math.round(parseInt(a.displayWeight*d)/i),k=i*Math.round(parseInt(a.displayWeight*e)/i);j<a.displayWeight-f&&(j=a.displayWeight-f),k>a.displayWeight+g&&(k=a.displayWeight+g);for(var l=0;k>=j&&l++<10;){var m=new SetFactory(j,a.barbellWeight,a.platesToUse,!1,{percent:a.percent,reps:a.reps,units:a.units});j+=i,newSetDifference=Math.abs(m.displayWeight-c.displayWeight),m.plateConfiguration.length<=b.plateConfiguration.length&&(b=m,h=newSetDifference)}return b}}function StorageHandler(a){if("string"!=typeof a||0===a.length)throw new Error("Environment (production/testing) must be set");this.environment=a,this.isSupported=function(){return"undefined"!=typeof Storage},this.getKey=function(a){return this.environment+"-"+a},this.getWithDefault=function(a,b,c){return this.isSupported()&&this.storageKeyExists(a)?c?JSON.parse(localStorage[this.getKey(a)]):localStorage[this.getKey(a)]:b},this.storageKeyExists=function(a){return"undefined"!=typeof localStorage[this.getKey(a)]},this.set=function(a,b,c){this.isSupported()&&(c&&(b=JSON.stringify(b)),localStorage[this.getKey(a)]=b)}}var barbellWeights={LB:[45,35],KG:[20,15]},plateWeights={LB:[2.5,5,10,25,35,45],KG:[1,2.5,5,10,15,20]},defaultPlates={LB:[{size:2.5,total:10,available:!0},{size:5,total:10,available:!0},{size:10,total:10,available:!0},{size:25,total:10,available:!0},{size:35,total:10,available:!0},{size:45,total:10,available:!0}],KG:[{size:1,total:10,available:!0},{size:2.5,total:10,available:!0},{size:5,total:10,available:!0},{size:10,total:10,available:!0},{size:15,total:10,available:!0},{size:20,total:10,available:!0}]},warmupScheme=[{reps:5,percent:40},{reps:3,percent:67},{reps:2,percent:80},{reps:1,percent:90}];SetFactory.prototype.removeSmallPlates=function(a,b){var c=[];c.push(a.shift(),a.shift()),plateThreshold="LB"==b?5:2.5;for(var d=0;d<c.length;d++)c[d].size>plateThreshold&&a.unshift(c[d]);return a},SetFactory.prototype.calculateSet=function(a,b,c){for(var d=a-b,e=[],f=0;d>0&&c.length>0;){var g=c[c.length-1];g.available||(g.total=0);var h=parseInt(g.total)-f,i=2*g.size;d-i>=0&&h>0?(d-=i,f++):c.pop(),f>0&&(0===h||0>d-i)&&(e.push(new PlateConfiguration(g.size,f)),f=0)}return new Set(a-d,e)},function(){window.console||(window.console={});for(var a=["log","info","warn","error","debug","trace","dir","group","groupCollapsed","groupEnd","time","timeEnd","profile","profileEnd","dirxml","assert","count","markTimeline","timeStamp","clear"],b=function(){},c=0;c<a.length;c++)window.console[a[c]]||(window.console[a[c]]=b)}();var $=jQuery.noConflict(),plateMapping={create:function(a){return new Plate(a.data.size,a.data.total,a.data.available)}},Plate=function(a,b,c){var d=this;d.size=ko.observable(a),d.total=ko.observable(b),d.available=ko.observable(c),d.available.subscribe(function(){m.notifySubscribers(null,"plates-available")}),d.total.subscribe(function(){m.notifySubscribers(null,"plate-totals")})},SettingsToggle=function(){var a=this;a.settingsVisible=ko.observable(!1),a.toggleSettings=function(){a.settingsVisible(!a.settingsVisible());var b="opened";a.settingsVisible()||(b="closed"),m.notifySubscribers(a.settingsVisible(),"settings-visible"),ga("send","event","settings","toggled",b)},m.subscribe(function(){a.settingsVisible(!1),m.notifySubscribers(a.settingsVisible(),"settings-visible")},a,"close-settings")},BarbellView=function(a){var b=this;"undefined"==typeof a&&(a="production"),b.units=ko.observableArray(["LB","KG"]),b.storageHandler=new StorageHandler(a),b.weightUnit=ko.observable(b.storageHandler.getWithDefault("weightUnit","LB")),b.weightUnit.subscribe(function(a){b.barbellWeights(barbellWeights[a]),b.barbellWeight(barbellWeights[a][0]),b.loadPlates(),b.storageHandler.set("weightUnit",a)}),b.barbellWeights=ko.observableArray(barbellWeights[b.weightUnit()]),b.barbellWeight=ko.observable(barbellWeights[b.weightUnit()][0]),b.barbellWeightDisplay=function(a){return a+" "+b.weightUnit()},b.plates=ko.mapping.fromJS(b.storageHandler.getWithDefault("plates"+b.weightUnit(),defaultPlates[b.weightUnit()],!0),plateMapping),b.loadPlates=function(){ko.mapping.fromJS(b.storageHandler.getWithDefault("plates"+b.weightUnit(),defaultPlates[b.weightUnit()],!0),b.plates)};var c=function(){b.storageHandler.set("plates"+b.weightUnit(),ko.toJSON(b.plates))};m.subscribe(c,b,"plates-available"),m.subscribe(c,b,"plates-totals"),b.showGhostLabel=ko.observable(!0),b.weightToCalculate=ko.observable(),b.weightToCalculate.subscribe(function(a){b.showGhostLabel(!1),weightLength=null===a?0:a.length,3!=weightLength||b.multiWeightMode()||b.isSelected(!1)}),b.isSelected=ko.observable(!0),b.isSelected.subscribe(function(a){a||(b.calculateSets(),setTimeout(b.resetInput,500))}),b.resetInput=function(){b.weightToCalculate(null),b.showGhostLabel(!0)},b.displayConfigurationsNumber=3,b.allSetEntries=b.storageHandler.getWithDefault("setEntries",[],!0),b.setEntries=ko.observableArray(b.allSetEntries.slice(0,b.displayConfigurationsNumber)),b.plateClass=function(a,b,c){return"plate-"+String(a).replace(".","--")+b+" plate-count-"+c},b.padAndReverse=function(a,b){for(i=a.length;b>i;i++)a.push({size:0,count:0});return a.reverse()},b.ignoreSmallPlates=ko.observable("false"!=b.storageHandler.getWithDefault("ignoreSmallPlates",!0)),b.ignoreSmallPlates.subscribe(function(a){b.storageHandler.set("ignoreSmallPlates",a)}),b.preferFewerPlates=ko.observable("false"!=b.storageHandler.getWithDefault("preferFewerPlates","false")),b.preferFewerPlates.subscribe(function(a){b.storageHandler.set("preferFewerPlates",a)}),b.multiWeightMode=ko.observable("false"!=b.storageHandler.getWithDefault("multiWeightMode","false")),b.multiWeightMode.subscribe(function(a){b.storageHandler.set("multiWeightMode",a)}),b.warmupScheme=ko.observableArray(b.storageHandler.getWithDefault("warmupScheme",warmupScheme,!0)),b.addWarmupSet=function(){b.warmupScheme.push({percent:null,reps:null})},b.removeWarmupSet=function(){b.warmupScheme.pop()},b.serializeConfig=function(){var a=[];a.push("u: "+b.weightUnit()),a.push("bw: "+b.barbellWeight()),a.push("ig: "+b.ignoreSmallPlates()),a.push("op: "+b.preferFewerPlates()),a.push("mw: "+b.multiWeightMode());for(var c=0,d=b.warmupScheme().length;d>c;c++)a.push(b.warmupScheme()[c].reps+" @ "+b.warmupScheme()[c].percent+"%");return a.join(" | ")},b.calculateSets=function(){if("undefined"==typeof b.weightToCalculate()||null===b.weightToCalculate()||b.weightToCalculate()<b.barbellWeight()||isNaN(b.weightToCalculate())&&!b.multiWeightMode())return!1;m.notifySubscribers(!1,"close-settings");var a=new SetScheme({units:b.weightUnit(),barbellWeight:b.barbellWeight(),weightToCalculate:b.weightToCalculate(),plates:JSON.parse(ko.toJSON(b.plates())),ignoreSmallPlates:b.ignoreSmallPlates(),warmupScheme:b.warmupScheme().slice(0),optimize:b.preferFewerPlates(),multiWeightMode:b.multiWeightMode()}),c=a.calculateSets(),d=b.multiWeightMode()?c.length>0?c[c.length-1].displayWeight:b.barbellWeight():b.weightToCalculate();b.allSetEntries.unshift({unit:b.weightUnit(),weight:d,platePadding:a.maxPlates,sets:c}),b.allSetEntries.slice(0,20),b.setEntries(b.allSetEntries.slice(0,b.displayConfigurationsNumber)),b.storageHandler.set("setEntries",b.allSetEntries,!0),ga("send","event","calculate","weight entered",b.weightToCalculate()+b.weightUnit()),ga("send","event","calculate","config setings",b.serializeConfig())},b.slideDownConfig=function(a){1===a.nodeType&&$(a).hide().slideDown()};var d=["set max plates","save max plates"];b.maxPlatesText=ko.observable(d[0]),b.maxPlatesVisible=ko.observable(),b.toggleMaxPlates=function(){b.maxPlatesVisible(!b.maxPlatesVisible()),b.maxPlatesText(d[0|b.maxPlatesVisible()]),c()},b.settingsVisible=ko.observable(!1),m.subscribe(function(a){b.settingsVisible(a),a||(b.filterAndSaveWarmupScheme(),b.maxPlatesVisible(!b.maxPlatesVisible()),b.maxPlatesText(d[0|b.maxPlatesVisible()]),c())},b,"settings-visible"),b.filterAndSaveWarmupScheme=function(){b.warmupScheme(ko.utils.arrayFilter(b.warmupScheme(),function(a){return a.reps>0&&a.percent>10})),b.storageHandler.set("warmupScheme",b.warmupScheme(),!0)}};