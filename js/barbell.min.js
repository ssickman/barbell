/*! barbell 2014-04-14 */
function PlateConfiguration(a,b){this.size=a,this.count=b}function Set(a,b){this.displayWeight=a,this.plateConfiguration=b}function SetScheme(a){for(var b=["units","barbellWeight","weightToCalculate","plateWeightsAvailable","plateWeightQuantities","ignoreSmallPlates","warmupScheme"],c=["optimize","multiWeightMode"],d=0;d<b.length;d++){if("undefined"==typeof a[b[d]])throw new Error("required key "+b[d]+" is missing");this[b[d]]=a[b[d]]}for(var d=0;d<c.length;d++)this[c[d]]="undefined"!=typeof a[c[d]]?a[c[d]]:!1;this.warmupScheme.push({percent:100,reps:0}),this.maxPlates=0,this.calculateSets=function(){if(this.multiWeightMode){var a=this.weightToCalculate.split(/[\s*,+#;]+/);this.warmupScheme=[];for(var b=[],c=0,d=a.length;d>c;c++)!isNaN(a[c])&&a[c]>0&&(this.warmupScheme.push({percent:100,reps:0}),b.push(a[c]))}for(var e=[],f=new PlateOptimizer,c=0;c<this.warmupScheme.length;c++){var g=this.multiWeightMode?b[c]:parseInt(this.weightToCalculate*this.warmupScheme[c].percent/100),h=new SetFactory(g,this.barbellWeight,this.plateWeightsAvailable.slice(0),this.plateWeightQuantities,this.ignoreSmallPlates&&100!=this.warmupScheme[c].percent,{percent:this.warmupScheme[c].percent,reps:this.warmupScheme[c].reps,units:this.units});this.optimize&&(h=f.optimize(h)),e.push(h),this.maxPlates=h.plateConfiguration.length>this.maxPlates?h.plateConfiguration.length:this.maxPlates}return e}}function SetFactory(a,b,c,d,e,f){var g=c.slice();g.sort(function(a,b){return a-b}),e&&(g=this.removeSmallPlates(g.slice(0),f.units));var h=g.slice(0),i=this.calculateSet(a,b,g,d);if(i.barbellWeight=b,i.platesToUse=h,i.ignoreSmallPlates=e,i.plateWeightQuantities=d,"object"==typeof f)for(var j in f)i[j]=f[j];return i}function PlateOptimizer(){this.optimize=function(a){if(!(a instanceof Set))throw new Error("PlateOptimizer.optimize accepts only Set() objects");if(100==a.percent)return a;var b=a,c=(a.platesToUse.slice(),new SetFactory(a.displayWeight,a.barbellWeight,a.platesToUse,a.plateWeightQuantities,!1,{percent:a.percent,reps:a.reps,units:a.units})),d=.9,e=1+(100-a.percent)/2.5/100,f="LB"==a.units?15:8,g="LB"==a.units?20:10,h=c.displayWeight-b.displayWeight,i="LB"==a.units?5:2,j=i*Math.round(parseInt(a.displayWeight*d)/i),k=i*Math.round(parseInt(a.displayWeight*e)/i);j<a.displayWeight-f&&(j=a.displayWeight-f),k>a.displayWeight+g&&(k=a.displayWeight+g);for(var l=0;k>=j&&l++<10;){var m=new SetFactory(j,a.barbellWeight,a.platesToUse,a.plateWeightQuantities,!1,{percent:a.percent,reps:a.reps,units:a.units});j+=i,newSetDifference=Math.abs(m.displayWeight-c.displayWeight),m.plateConfiguration.length<=b.plateConfiguration.length&&(b=m,h=newSetDifference)}return b}}function StorageHandler(a){if("string"!=typeof a||0==a.length)throw new Error("Environment (production/testing) must be set");this.environment=a,this.isSupported=function(){return"undefined"!=typeof Storage},this.getKey=function(a){return this.environment+"-"+a},this.getWithDefault=function(a,b,c){return this.isSupported()&&this.storageKeyExists(a)?c?JSON.parse(localStorage[this.getKey(a)]):localStorage[this.getKey(a)]:b},this.storageKeyExists=function(a){return"undefined"!=typeof localStorage[this.getKey(a)]},this.set=function(a,b,c){this.isSupported()&&(c&&(b=JSON.stringify(b)),localStorage[this.getKey(a)]=b)}}var barbellWeights={LB:[45,35],KG:[20,15]},plateWeights={LB:[2.5,5,10,25,35,45],KG:[1,2.5,5,10,15,20]},plateWeightQuantities={};for(unit in plateWeights){plateWeightQuantities[unit]=[];for(var i=0,length=plateWeights[unit].length;length>i;i++)plateWeightQuantities[unit].push({size:plateWeights[unit][i],total:10})}var warmupScheme=[{reps:5,percent:40},{reps:3,percent:67},{reps:2,percent:80},{reps:1,percent:90}];SetFactory.prototype.removeSmallPlates=function(a,b){var c=[];c.push(a.shift(),a.shift()),plateThreshold="LB"==b?5:2.5;for(var d=0;d<c.length;d++)c[d]>plateThreshold&&a.unshift(c[d]);return a},SetFactory.prototype.calculateSet=function(a,b,c,d){for(var e=a-b,f=[],g=0;e>0&&c.length>0;){var h=c[c.length-1],i=parseInt(d[h])-g,j=2*h;e-j>=0&&i>0?(e-=j,g++):c.pop(),g>0&&(0==i||0>e-j)&&(f.push(new PlateConfiguration(h,g)),g=0)}return new Set(a-e,f)},function(){window.console||(window.console={});for(var a=["log","info","warn","error","debug","trace","dir","group","groupCollapsed","groupEnd","time","timeEnd","profile","profileEnd","dirxml","assert","count","markTimeline","timeStamp","clear"],b=0;b<a.length;b++)window.console[a[b]]||(window.console[a[b]]=function(){})}();var $=jQuery.noConflict(),BarbellView=function(a){var b=this;"undefined"==typeof a&&(a="production"),b.units=ko.observableArray(["LB","KG"]),b.storageHandler=new StorageHandler(a),b.weightUnit=ko.observable(b.storageHandler.getWithDefault("weightUnit","LB")),b.weightUnit.subscribe(function(a){b.barbellWeights(barbellWeights[a]),b.barbellWeight(barbellWeights[a][0]),b.plateWeights(plateWeights[a]),b.plateWeightsAvailable(b.storageHandler.getWithDefault("plateWeightsAvailable"+b.weightUnit(),plateWeights[b.weightUnit()],!0)),b.plateWeightQuantities(b.storageHandler.getWithDefault("plateWeightQuantities"+b.weightUnit(),plateWeightQuantities[b.weightUnit()],!0)),b.storageHandler.set("weightUnit",a)}),b.barbellWeights=ko.observableArray(barbellWeights[b.weightUnit()]),b.barbellWeight=ko.observable(barbellWeights[b.weightUnit()][0]),b.barbellWeightDisplay=function(a){return a+" "+b.weightUnit()},b.plateWeights=ko.observableArray(plateWeights[b.weightUnit()]),b.plateWeightsAvailable=ko.observableArray(b.storageHandler.getWithDefault("plateWeightsAvailable"+b.weightUnit(),plateWeights[b.weightUnit()],!0)),b.plateWeightsAvailable.subscribe(function(a){currentPlatesAvailable=b.storageHandler.getWithDefault("plateWeightsAvailable"+b.weightUnit(),plateWeights[b.weightUnit()],!0),0==a.length&&1==currentPlatesAvailable.length?b.plateWeightsAvailable(currentPlatesAvailable):b.storageHandler.set("plateWeightsAvailable"+b.weightUnit(),a,!0)}),b.plateWeightQuantities=ko.observableArray(b.storageHandler.getWithDefault("plateWeightQuantities"+b.weightUnit(),plateWeightQuantities[b.weightUnit()],!0)),b.savePlateWeightQuantities=function(){b.storageHandler.set("plateWeightQuantities"+b.weightUnit(),b.plateWeightQuantities(),!0),b.indexPlateWeightQuantities()},b.plateWeightQuantitiesIndex={},b.indexPlateWeightQuantities=function(){b.plateWeightQuantitiesIndex={};for(var a=0,c=b.plateWeightQuantities().length;c>a;a++){var d=b.plateWeightQuantities()[a];b.plateWeightQuantitiesIndex[d.size]=d.total}},b.indexPlateWeightQuantities(),b.showGhostLabel=ko.observable(!0),b.weightToCalculate=ko.observable(),b.weightToCalculate.subscribe(function(a){b.showGhostLabel(!1),weightLength=null==a?0:a.length,3!=weightLength||b.multiWeightMode()||b.isSelected(!1)}),b.isSelected=ko.observable(!0),b.isSelected.subscribe(function(a){a||(b.calculateSets(),setTimeout(b.resetInput,500))}),b.resetInput=function(){b.weightToCalculate(null),b.showGhostLabel(!0)},b.displayConfigurationsNumber=3,b.allSetEntries=b.storageHandler.getWithDefault("setEntries",[],!0),b.setEntries=ko.observableArray(b.allSetEntries.slice(0,b.displayConfigurationsNumber)),b.plateClass=function(a,b,c){return"plate-"+String(a).replace(".","--")+b+" plate-count-"+c},b.padAndReverse=function(a,b){for(i=a.length;b>i;i++)a.push({size:0,count:0});return a.reverse()},b.ignoreSmallPlates=ko.observable("false"!=b.storageHandler.getWithDefault("ignoreSmallPlates",!0)),b.ignoreSmallPlates.subscribe(function(a){b.storageHandler.set("ignoreSmallPlates",a)}),b.preferFewerPlates=ko.observable("false"!=b.storageHandler.getWithDefault("preferFewerPlates","false")),b.preferFewerPlates.subscribe(function(a){b.storageHandler.set("preferFewerPlates",a)}),b.multiWeightMode=ko.observable("false"!=b.storageHandler.getWithDefault("multiWeightMode","false")),b.multiWeightMode.subscribe(function(a){b.storageHandler.set("multiWeightMode",a)}),b.warmupScheme=ko.observableArray(b.storageHandler.getWithDefault("warmupScheme",warmupScheme,!0)),b.addWarmupSet=function(){b.warmupScheme.push({percent:null,reps:null})},b.removeWarmupSet=function(){b.warmupScheme.pop()},b.serializeConfig=function(){var a=[];a.push("u: "+b.weightUnit()),a.push("bw: "+b.barbellWeight()),a.push("ig: "+b.ignoreSmallPlates()),a.push("op: "+b.preferFewerPlates()),a.push("mw: "+b.multiWeightMode());for(var c=0,d=b.warmupScheme().length;d>c;c++)a.push(b.warmupScheme()[c].reps+" @ "+b.warmupScheme()[c].percent+"%");return a.join(" | ")},b.calculateSets=function(){if(null==b.weightToCalculate()||b.weightToCalculate()<b.barbellWeight()||isNaN(b.weightToCalculate())&&!b.multiWeightMode())return!1;b.settingsVisible()&&b.toggleSettings();var a=new SetScheme({units:b.weightUnit(),barbellWeight:b.barbellWeight(),weightToCalculate:b.weightToCalculate(),plateWeightsAvailable:b.plateWeightsAvailable().slice(0),plateWeightQuantities:b.plateWeightQuantitiesIndex,ignoreSmallPlates:b.ignoreSmallPlates(),warmupScheme:b.warmupScheme().slice(0),optimize:b.preferFewerPlates(),multiWeightMode:b.multiWeightMode()}),c=a.calculateSets(),d=b.multiWeightMode()?c.length>0?c[c.length-1].displayWeight:b.barbellWeight():b.weightToCalculate();b.allSetEntries.unshift({unit:b.weightUnit(),weight:d,platePadding:a.maxPlates,sets:c}),b.allSetEntries.slice(0,20),b.setEntries(b.allSetEntries.slice(0,b.displayConfigurationsNumber)),b.storageHandler.set("setEntries",b.allSetEntries,!0),ga("send","event","calculate","weight entered",b.weightToCalculate()+b.weightUnit()),ga("send","event","calculate","config setings",b.serializeConfig())},b.slideDownConfig=function(a){1===a.nodeType&&$(a).hide().slideDown()},b.settingsVisible=ko.observable(!1),b.settingsVisible.subscribe(function(a){a||(b.filterAndSaveWarmupScheme(),b.savePlateWeightQuantities())}),b.filterAndSaveWarmupScheme=function(){b.warmupScheme(ko.utils.arrayFilter(b.warmupScheme(),function(a){return a.reps>0&&a.percent>10})),b.storageHandler.set("warmupScheme",b.warmupScheme(),!0)},b.toggleSettings=function(){b.settingsVisible(!b.settingsVisible());var a="opened";b.settingsVisible()||(a="closed"),ga("send","event","settings","toggled",a)}};